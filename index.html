<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>English 3 Speaking Milestone 3</title>
  <base href="/leshya5e/">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1f2937">

  <style>
    :root { --brand:#468283; --accent:#84BD00; }
    body{margin:0;background:#f9fafb;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #overlay{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:9999;pointer-events:none}
    .wrap{max-width:900px;margin:24px auto;padding:12px}
    h1{color:var(--brand);margin:0 0 12px 0}
    .prompt{background:#f7f7f7;border:2px solid #EBEBEB;color:var(--brand);border-radius:10px;padding:16px;font-size:22px;min-height:120px}
    .ctr{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:24px}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:12px 22px;font-size:18px;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .btn:active{transform:scale(.98)}
    #image_holder{display:none;text-align:center;margin-top:10px}
    #image_holder img{max-width:280px;max-height:180px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    .count{margin-top:8px;color:#111}
  </style>
</head>
<body>
  <div id="overlay"><div>Loading…</div></div>

  <div class="wrap">
    <h1 id="pageHead" style="display:none">English 3 Speaking Milestone 3</h1>

    <div id="pCount" class="count"><span id="pno"></span><span id="pto"></span></div>

    <div id="promptHolder" class="prompt">
      <h2 style="margin:0 0 8px 0;color:var(--brand)">English 3 Speaking Milestone 3</h2>
      <div>This assessment includes 12 fixed prompts (one per function). Press Continue to begin.</div>
    </div>

    <div id="image_holder">
      <img id="promptPic" src="" alt="prompt image">
    </div>

    <div class="ctr">
      <button class="btn" id="butt">Continue</button>
      <button class="btn" id="butt1" style="display:none">OK</button>
      <button class="btn" id="butt2" style="display:none">Start</button>
      <button class="btn" id="butt3" style="display:none">Restart</button>
    </div>
  </div>

  <audio id="player" preload="auto" playsinline></audio>
  <script src="prompts.js"></script>

  <script>
    // أخفي طبقة التحميل بمجرد تحميل الصفحة
    window.addEventListener('load', function(){ const ov=document.getElementById('overlay'); if(ov) ov.style.display='none'; });

    // حالة التطبيق
    const promptBank = Array.isArray(window.prompts) ? window.prompts.slice(0,12) : [];
    let idx = 0;

    // عناصر DOM
    const pageHead = document.getElementById('pageHead');
    const promptHolder = document.getElementById('promptHolder');
    const imageHolder  = document.getElementById('image_holder');
    const promptPic    = document.getElementById('promptPic');
    const pno = document.getElementById('pno');
    const pto = document.getElementById('pto');
    const btnContinue = document.getElementById('butt');
    const btnOK = document.getElementById('butt1');
    const btnNext = document.getElementById('butt2');
    const btnRestart = document.getElementById('butt3');
    const audio = document.getElementById('player');

    // عداد الإجمالي
    pto.textContent = promptBank.length ? "12" : "0";

    function render(i){
      const p = promptBank[i];
      if(!p) return;

      pageHead.style.display = 'block';
      promptHolder.textContent = p.text || '';

      if(p.image){
        imageHolder.style.display = 'block';
        promptPic.src = p.image;
      }else{
        imageHolder.style.display = 'none';
      }

      pno.textContent = (i+1) + " / ";
      btnNext.style.display = 'none'; // نخفي "Next" حتى ينتهي الصوت

      // تشغيل صوت واحد فقط بلا تداخل
      audio.pause(); audio.currentTime = 0;
      if(p.audio){ // إذا فيه ملف صوت
        audio.src = p.audio;
        audio.play().catch(()=>{ /* لو سفاري رفض، المستخدم يضغط Next يدوي */ btnNext.style.display = 'block'; });
      }else{
        // لا يوجد صوت لهذا السؤال → أظهر Next مباشرة
        btnNext.style.display = 'block';
      }

      btnNext.textContent = (i === promptBank.length - 1) ? "Finish" : "Next";
    }

    audio.onended = () => { btnNext.style.display = 'block'; };

    // تدفّق الأزرار
    btnContinue.onclick = () => {
      btnContinue.style.display='none';
      promptHolder.innerHTML = '<p>Please say your name and badge number.</p><p>Tap OK to proceed.</p>';
      btnOK.style.display='inline-block';
    };
    btnOK.onclick = () => {
      btnOK.style.display='none';
      promptHolder.innerHTML = '<p>You will answer 12 fixed prompts (one for each function).</p><p>After you hear each prompt, respond, then tap “Next”.</p>';
      btnNext.textContent='Start';
      btnNext.style.display='inline-block';
    };
    btnNext.onclick = () => {
      if (btnNext.textContent === 'Start') {
        render(idx);
        idx++;
        return;
      }
      if (idx >= promptBank.length){
        promptHolder.textContent = 'You have finished.';
        btnNext.style.display='none';
        btnRestart.style.display='inline-block';
        return;
      }
      render(idx);
      idx++;
    };
    btnRestart.onclick = () => location.reload();

    // تسجيل Service Worker للمسار الفرعي
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/leshya5e/sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
