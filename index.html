<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>English 3 Speaking Milestone 3</title>

  <!-- jQuery من نفس المصدر اللي كنت تستخدمه -->
  <script src="https://aramco.blackboard.com/bbcswebdav/orgs/PEC/COMMON/JQUERY/jquery-3.6.4.min.js"></script>
  <script src="https://aramco.blackboard.com/bbcswebdav/orgs/PEC/COMMON/JQUERY/jquery-ui.min.js"></script>
  <script src="https://aramco.blackboard.com/bbcswebdav/orgs/PEC/COMMON/JQUERY/jquery.ui.touch-punch.min.js"></script>

  <!-- ربط قائمة الأسئلة الثابتة -->
  <script src="prompts.js"></script>
<script>
/* === ثابت: استخدم 12 من prompts.js، بدون شَفل، وصوت واحد لكل مرة === */
(function(){
  window.shuffle = function(a){ return a; };       // عطّل أي شَفل
  window.promptBank = Array.isArray(window.prompts) ? window.prompts.slice(0,12) : [];

  // عدّاد أعلى يمين
  var pto = document.getElementById('pto'); if (pto) pto.textContent = String(window.promptBank.length);

  // قناة صوت واحدة (لا تداخل)
  var single = new Audio(); single.preload='auto'; single.playsInline = true;

  window.audioElements = window.promptBank.map(function(p){
    var file = p.audio || '';
    if (file && !/\.mp3$/i.test(file)) file += '.mp3'; // ضمان الامتداد
    return {
      play: function(){
        try{ single.pause(); single.currentTime = 0; }catch(_){}
        if (file){
          single.src = file;
          var pr = single.play(); if (pr && pr.catch) pr.catch(function(){});
        } else {
          // سؤال بلا صوت → أظهر Next فوراً
          var b = document.getElementById('butt2'); if (b) b.style.display = 'block';
          try{ $('#butt2').fadeIn(); }catch(_){}
        }
      },
      pause: function(){ try{ single.pause(); }catch(_){ } }
    };
  });

  single.onended = function(){
    var b = document.getElementById('butt2'); if (b) b.style.display = 'block';
    try{ $('#butt2').fadeIn(); }catch(_){}
  };

  // أخفِ الـ overlay لو ظاهر
  var ov = document.getElementById('overlay');
  if (ov){ ov.style.display='none'; ov.style.pointerEvents='none'; ov.style.zIndex='-1'; }
})();
</script>

  <style>
    .promptHolder{background:#f7f7f7;border:2px solid #EBEBEB;color:#468283;font-size:calc(1.75vw + 1.75vh);width:90%;border-radius:10px;margin:auto;font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif;justify-content:center;align-items:center;padding:1em;}
    #pageHead{color:#468283;font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif}
    #cont{text-align:center;height:95vh;width:95vw;overflow:scroll;margin:auto;}
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.7);display:flex;justify-content:center;align-items:center;z-index:1000;}
    .butt{background:#84BD00;color:#fff;border-radius:6px;width:100px;left:50%;transform:translateX(-50%) translateZ(0);padding:10px;text-align:center;font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif;font-size:1.5em;box-shadow:0 2px 5px rgba(0,0,0,.3);position:fixed;bottom:20px;cursor:pointer;}
    .pCount{width:93vw;text-align:center;font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif;}
    .zoom{position:absolute;top:5px;left:5px;width:100vw;height:100vh;background:rgba(255,255,255,.9);z-index:999;}
    .butt:active{transform:translateX(-50%) translateZ(0) scale(.96);box-shadow:0 2px 4px rgba(0,0,0,.3);}
    #imageHolder{width:90%;justify-content:center;cursor:pointer;display:none;margin:auto;overflow:visible;}
    #promptPic{display:block;margin:10px auto;max-width:250px;max-height:150px;box-shadow:0 2px 2px rgba(0,0,0,.3);cursor:pointer;}
    @media (max-width:750px){.promptHolder{font-size:2em;width:85%}.pCount{width:85%;padding-left:5rem}}
    @media (max-width:500px){.pCount{padding-left:3rem}#promptPic{max-width:150px}}
  </style>

  <script>
    /* ——— حالتك العامة ودوال الواجهة كما كانت ——— */
    window.sounds = [];
    window.promptBank = [];
    window.counter = 0;

    window.shuffle = function(a){ return a; }; // عطّل أي شَفل

    window.introPage = function(){
      $("#butt").hide();
      $("#promptHolder").html(`<h2 class="iHead" style="font-size: 2rem">English 3 Speaking Milestone 3</h2>
      <div class="iText" style="font-size: 1.5rem; font-weight: 500; margin-top:8vh">
        <p style="line-height: 2rem; display: block;">Please say your name and badge number.</p><p> Tap OK to proceed.</p>
      </div>`);
      $("#butt1").fadeIn(500);
      try{ badge.play(); }catch(_){}
    }

    window.landingPage = function(){
      try{ badge.pause(); }catch(_){}
      $("#butt1").hide();
      $("#promptHolder").html(`<h2 class="iHead" style="font-size: 2rem">English 3 Speaking Milestone 3</h2>
      <div class="iText" style="font-size: 1.5rem; font-weight: 500; margin-top:8vh; line-height: 1.5rem">
        <p>You will see and hear 12 fixed prompts.</p>
        <p>After you hear each prompt, respond.</p>
        <p>If you see a picture, tap it to enlarge.</p>
        <p>Tap “Next” to move forward. When ready, tap “Start”.</p>
      </div>`);
      $("#butt2").fadeIn(500);
      try{ instr.play(); }catch(_){}
    }

    window.startActivity = function(){
      try{ instr.pause(); }catch(_){}
      $("#butt2").hide();
      $("#pageHead").show();
      $("#butt2").text("Next");
      document.getElementById('image_holder').style.display = "none";
      window.counter++;

      if(window.counter > window.promptBank.length){
        $("#promptHolder").text("You have finished.");
        $("#pCount").hide();
        $("#butt2").hide();
        $("#butt3").fadeIn();
        try{ endBlurb.play(); }catch(_){}
      }else{
        $("#pCount").show();
        const item = window.promptBank[window.counter-1];
        $("#promptHolder").text(item.text || "");
        audioElements[window.counter-1].play();
        $("#pno").text(window.counter + " / ");
        if(item.image){
          document.getElementById('image_holder').style.display = "block";
          document.getElementById('promptPic').src = item.image;
        }
      }
    }

    window.enlarge = function(){
      $("#image_holder").addClass('zoom');
      var tgtImg = document.getElementById('promptPic');
      tgtImg.style.maxWidth = "80vw";
      tgtImg.style.maxHeight = "75vh";
      document.getElementById('cap').style.backgroundColor = "white";
      document.getElementById('cap').style.fontSize = "1.25rem";
      document.getElementById('cap').innerText = document.getElementById('promptHolder').innerText;
      document.getElementById('closeX').style.display = "block";
    }
    window.closeImg = function(){
      $("#cap").text("Tap to enlarge");
      document.getElementById('cap').style.fontSize = "1rem";
      $('#image_holder').removeClass('zoom');
      document.getElementById('promptPic').style.maxWidth = "250px";
      document.getElementById('closeX').style.display = "none";
    }
    window.startOver = function(){ location.reload(); }
  </script>
</head>

<body>
  <div id="overlay"><img src="loading.gif" alt="Loading" id="loading-image"></div>

  <div id="cont">
    <h1 id="pageHead" style="display:none;">English 3 Speaking Milestone 3</h1>
    <div id="pCount" class="pCount">
      <div style="margin-left:auto;margin-right:0;margin-bottom:5px;width:75px;padding:5px;border-radius:7px;">
        <span id="pno" style="font-size:1.25em"></span><span id="pto"></span>
      </div>
    </div>

    <div class="promptHolder" id="promptHolder">
      <h2 class="iHead" style="font-size:2rem;margin:0 0 1.5rem 0">English 3 Speaking Milestone 3</h2>
      <div class="iText" style="font-size:1.5rem;font-weight:500;margin-top:.5rem">
        <span style="font-weight:bold">This assessment covers these functions:</span>
      </div>
      <div class="iText" style="display:flex;justify-content:center;margin-left:auto;font-size:1.5rem;">
        <ul style="text-align:left;">
          <li>Talking about rules</li>
          <li>Making, accepting, and refusing offers</li>
          <li>Talking about willingness</li>
          <li>Inviting and handling questions</li>
          <li>Asking for, offering, and providing clarification</li>
          <li>Talking about requirements</li>
          <li>Talking about mistakes</li>
          <li>Talking about abbreviations</li>
          <li>Assigning tasks</li>
          <li>Talking about responsibilities</li>
          <li>Talking about purpose and function</li>
          <li>Talking about range and duration</li>
        </ul>
      </div>
    </div>

    <div id="image_holder" style="display:none">
      <span id="closeX" style="text-align:center; position:absolute; right:2%; font-family:arial; font-weight:bold; display:none; background-color:black; border-radius:20px; padding:5px; width:20px; color:white;" onclick="closeImg()">X</span>
      <img id="promptPic" src="" onclick="enlarge()">
      <p id="cap" style="text-align:center; font-family:'Trebuchet MS'">Tap to enlarge</p>
    </div>

    <div style="margin-top:2em">
      <div class="butt" id="butt"  onclick="introPage()">Continue</div>
      <div class="butt" id="butt1" style="display:none;" onclick="landingPage()">OK</div>
      <div class="butt" id="butt2" style="display:none;" onclick="startActivity()">Start</div>
      <div class="butt" id="butt3" style="display:none" onclick="startOver();">Restart</div>
    </div>
  </div>

  <!-- أصوات الواجهة (اختياري) -->
  <script>
    window.endBlurb = new Audio("E3_E4_End.mp3");
    window.badge    = new Audio("E3_SM3_Intro.mp3");
    window.instr    = new Audio("E3_4_SM3_Inst.mp3");
  </script>

  <!-- تهيئة: استخدم 12 سؤال من prompts.js + قناة صوت واحدة + أخفِ overlay -->
  <script>
  (function(){
    // حضّر بنك الأسئلة (أول 12 من prompts.js)
    window.promptBank = Array.isArray(window.prompts) ? window.prompts.slice(0,12) : [];
    // عدّاد أعلى يمين
    var pto = document.getElementById('pto'); if (pto) pto.textContent = String(window.promptBank.length);

    // قناة صوت واحدة (لا تداخل)
    var single = new Audio(); single.preload='auto'; single.playsInline = true;
    window.audioElements = window.promptBank.map(function(p){
      var file = p.audio || '';
      if (file && !/\.mp3$/i.test(file)) file += '.mp3';
      return {
        play: function(){
          try{ single.pause(); single.currentTime=0; }catch(_){}
          if(file){
            single.src = file;
            var pr = single.play(); if (pr && pr.catch) pr.catch(function(){});
          }else{
            var b=document.getElementById('butt2'); if(b) b.style.display='block';
            try{ $('#butt2').fadeIn(); }catch(_){}
          }
        },
        pause: function(){ try{ single.pause(); }catch(_){} }
      };
    });
    single.onended = function(){
      var b=document.getElementById('butt2'); if(b) b.style.display='block';
      try{ $('#butt2').fadeIn(); }catch(_){}
    };

    // أخفِ overlay كشبّاك أمان
    var ov=document.getElementById('overlay'); if(ov){ ov.style.display='none'; ov.style.pointerEvents='none'; ov.style.zIndex='-1'; }
    setTimeout(function(){ var ov=document.getElementById('overlay'); if(ov){ ov.style.display='none'; ov.style.pointerEvents='none'; ov.style.zIndex='-1'; } }, 8000);
  })();
  </script>
</body>
</html>
