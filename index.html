<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>English 3 Speaking Milestone 3</title>

<!-- jQuery من البلاكبورد (كما في ملفك) -->
<script src="https://aramco.blackboard.com/bbcswebdav/orgs/PEC/COMMON/JQUERY/jquery-3.6.4.min.js"></script>
<script src="https://aramco.blackboard.com/bbcswebdav/orgs/PEC/COMMON/JQUERY/jquery-ui.min.js"></script>
<script src="https://aramco.blackboard.com/bbcswebdav/orgs/PEC/COMMON/JQUERY/jquery.ui.touch-punch.min.js"></script>

<style>
  .promptHolder{
    background:#f7f7f7; border:2px solid #EBEBEB; color:#468283;
    font-size:calc(1.75vw + 1.75vh); width:90%; border-radius:10px; margin:auto;
    font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif;
    justify-content:center; align-items:center; padding:1em;
  }
  #pageHead{ color:#468283; font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif }
  #closeX{ cursor:pointer; }
  #cont{ text-align:center; height:95vh; width:95vw; overflow:scroll; margin:auto; }
  #overlay{
    position:fixed; inset:0; background-color:rgba(255,255,255,.7);
    display:flex; justify-content:center; align-items:center; z-index:1000;
  }
  .butt{
    background:#84BD00; color:#fff; border-radius:6px; width:100px; left:50%;
    transform:translateX(-50%) translateZ(0); padding:10px; text-align:center;
    font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif;
    font-size:1.5em; box-shadow:0 2px 5px rgba(0,0,0,.3); position:fixed; bottom:20px; cursor:pointer;
  }
  .pCount{ width:93vw; text-align:center; font-family:'Trebuchet MS','Lucida Sans Unicode','Lucida Grande','Lucida Sans',Arial,sans-serif; }
  .zoom{ position:absolute; top:5px; left:5px; width:100vw; height:100vh; background:#fffE; z-index:999; }
  .butt:active{ transform:translateX(-50%) translateZ(0) scale(.96); box-shadow:0 2px 4px rgba(0,0,0,.3); }
  #imageHolder{ width:90%; justify-content:center; cursor:pointer; display:none; margin:auto; overflow:visible; }
  #promptPic{ display:block; margin:10px auto; max-width:250px; max-height:150px; box-shadow:0 2px 2px rgba(0,0,0,.3); cursor:pointer; }

  @media (max-width:750px){
    .promptHolder{ font-size:2em; width:85%; }
    .pCount{ width:85%; padding-left:5rem; }
  }
  @media (max-width:500px){
    .pCount{ padding-left:3rem; }
    #promptPic{ max-width:150px; }
  }

  /* إصلاحات iPad: لا تسمح للـoverlay بحجب اللمس، وارفع الأزرار فوق أي طبقات */
  #overlay{ display:none !important; pointer-events:none !important; z-index:-1 !important; }
  *{ -webkit-tap-highlight-color:transparent; touch-action:manipulation; }
  #butt,#butt1,#butt2,#butt3,.ctr button{ position:relative; z-index:2147483647; pointer-events:auto !important; }
</style>

<script>
/* ---------- حالة عامة ---------- */
window.sounds = [];
window.promptBank = [];
window.counter = 0;

/* ---------- وظائفك (كما هي) ---------- */
const targetFunctions = [
  { func: "TALKING_ABOUT_RULES", subs: ["TRY_IT_1","TRY_IT_2"] },
  { func: "MAKING_ACCEPTING_AND_REFUSING_OFFERS", subs: ["TRY_IT_1","TRY_IT_2"] },
  { func: "TALKING_ABOUT_WILLINGNESS", subs: ["TRY_IT_1","TRY_IT_2"] },
  { func: "INVITING_AND_HANDLING_QUESTIONS", subs: ["TRY_IT_1"] },
  { func: "ASKING_FOR_OFFERING_AND_PROVIDING_CLARIFICATION", subs: ["TRY_IT_1","TRY_IT_2"] },
  { func: "TALKING_ABOUT_REQUIREMENTS_AND_NECESSITIES", subs: ["TRY_IT_1","TRY_IT_2"] },
  { func: "TALKING_ABOUT_MISTAKES", subs: ["TRY_IT_1"] },
  { func: "TALKING_ABOUT_ABBREVIATIONS", subs: ["TRY_IT_1","TRY_IT_2"] },
  { func: "ASSIGNING_TASKS", subs: ["TRY_IT_1","TRY_IT_2"] },
  { func: "TALKING_ABOUT_ROLES_AND_RESPONSIBILITIES", subs: ["TRY_IT_1","TRY_IT_2"] },
  { func: "TALKING_ABOUT_PURPOSE_AND_FUNCTION", subs: ["TRY_IT_1","TRY_IT_2"] },
  { func: "TALKING_ABOUT_RANGE_AND_DURATION", subs: ["TRY_IT_1","TRY_IT_2"] }
];

/* ---------- مصدر الموارد ---------- */
const resources_bb_url = "https://aramco.blackboard.com/bbcswebdav/orgs/PEC/COMMON/TRY_IT/E3M/";

/* ---------- صفحات المقدمة كما هي ---------- */
window.introPage = function(){
  $("#butt").hide();
  $("#promptHolder").html(
    `<h2 class="iHead" style="font-size:2rem">English 3 Speaking Milestone 3</h2>
     <div class="iText" style="font-size:1.5rem;font-weight:500;margin-top:8vh">
       <p style="line-height:2rem">Please say your name and badge number.</p>
       <p>Tap OK to proceed.</p>
     </div>`
  );
  $("#butt1").fadeIn(500);
  badge.play();
}
window.landingPage = function(){
  badge.pause();
  $("#butt1").hide();
  $("#promptHolder").html(
    `<h2 class="iHead" style="font-size:2rem">English 3 Speaking Milestone 3</h2>
     <div class="iText" style="font-size:1.5rem;font-weight:500;margin-top:8vh;line-height:1.5rem">
       <p>You will see and hear 12 prompts (fixed once selected the first time).</p>
       <p>Respond after each prompt. Tap the picture to enlarge if present.</p>
       <p>Tap “Next” to move on. Tap “Start” when ready.</p>
     </div>`
  );
  $("#butt2").fadeIn(500);
  instr.play();
}

/* ---------- تكبير الصورة ---------- */
window.enlarge = function(){
  $("#image_holder").addClass('zoom');
  var tgtImg = document.getElementById('promptPic');
  tgtImg.style.maxWidth = "80vw"; tgtImg.style.maxHeight = "75vh";
  document.getElementById('cap').style.backgroundColor = "white";
  document.getElementById('cap').style.fontSize = "1.25rem";
  document.getElementById('cap').innerText = document.getElementById('promptHolder').innerText;
  document.getElementById('closeX').style.display = "block";
}
window.closeImg = function(){
  $("#cap").text("Tap to enlarge");
  document.getElementById('cap').style.fontSize = "1rem";
  $('#image_holder').removeClass('zoom');
  document.getElementById('promptPic').style.maxWidth = "250px";
  document.getElementById('closeX').style.display = "none";
}
window.startOver = function(){ location.reload(); };

/* ---------- الدوال الأصلية (بتعديل بسيط) ---------- */
function getPrompts(item) {
  // نجبره على مجلد TRY_IT_1 لضمان الثبات
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    var func = item.func;
    var subfolder = item.subs[0] || "TRY_IT_1";
    script.src = resources_bb_url + func + "/" + subfolder + "/prompts.js";
    var res_folder = resources_bb_url + func + "/" + subfolder + "/";
    script.onload = () => {
      const loadedPrompts = window.prompts || [];
      for (var p = 0; p < loadedPrompts.length; p++) {
        var oa = loadedPrompts[p].audio;
        loadedPrompts[p].audio = res_folder + oa;
        if ("image" in loadedPrompts[p] && loadedPrompts[p].image) {
          var oi = loadedPrompts[p].image;
          loadedPrompts[p].image = res_folder + oi;
        }
      }
      resolve(loadedPrompts);
    };
    script.onerror = () => reject(new Error("Script load error for " + script.src));
    document.head.appendChild(script);
  });
}

/* ========= باتش الحسم: تثبيت 12 سؤال + قناة صوت واحدة + منع العشوائية ========= */
(function(){
  // ألغِ العشوائية أينما استُخدمت
  window.shuffle = function(a){ return a; };

  const FIX_KEY = 'fixedPrompts_V1';
  function norm(x){
    if(!x) return {text:'',audio:'',image:''};
    let a = x.audio||''; if(a && !a.endsWith('.mp3')) a = a + '.mp3';
    return { text: x.text||'', audio: a, image: x.image||'' };
  }

  // استبدال processArray بنسخة حتمية
  window.processArray = async function(array){
    // لو فيه مجموعة مثبتة مسبقًا، استخدمها
    try{
      const saved = JSON.parse(localStorage.getItem(FIX_KEY) || 'null');
      if (saved && Array.isArray(saved) && saved.length === 12) {
        window.promptBank = saved.map(norm);
        buildAudioElements(window.promptBank);
        hideOverlay();
        $("#pCount").hide();
        $("#pto").text(promptBank.length);
        return;
      }
    }catch(_){}

    // لا يوجد مثبت → اجلب أول prompt من TRY_IT_1 لكل وظيفة
    const results = await Promise.all(array.map(getPrompts));
    window.promptBank = [];
    results.forEach(pr => { if(pr && pr.length) window.promptBank.push(pr[0]); });

    // ثبّت أول مرة
    try{ localStorage.setItem(FIX_KEY, JSON.stringify(window.promptBank)); }catch(_){}

    buildAudioElements(window.promptBank);
    hideOverlay();
    $("#pCount").hide();
    $("#pto").text(promptBank.length);
  };

  // قناة صوت واحدة (لا تداخل) + إظهار Next بعد انتهاء الصوت
  function buildAudioElements(bank){
    window.sounds = bank.map(p => p.audio ? (p.audio.endsWith('.mp3')?p.audio:(p.audio+'.mp3')) : "");
    const single = new Audio(); single.preload='auto'; single.playsInline = true;
    window.audioElements = sounds.map(file => ({
      play(){
        try{ single.pause(); single.currentTime=0; }catch(_){}
        if(file){
          single.src = file;
          const pr = single.play(); if(pr && pr.catch) pr.catch(()=>{});
        } else {
          try{ $('#butt2').fadeIn(); }catch(_){ const b=document.getElementById('butt2'); if(b) b.style.display='block'; }
        }
      },
      pause(){ try{ single.pause(); }catch(_){ } }
    }));
    single.onended = function(){
      try{ $('#butt2').fadeIn(); }catch(_){ const b=document.getElementById('butt2'); if(b) b.style.display='block'; }
    };
  }

  // إخفاء الـoverlay بأمان
  function hideOverlay(){
    const ov=document.getElementById('overlay');
    if(ov){ ov.style.display='none'; ov.style.pointerEvents='none'; ov.style.zIndex='-1'; }
  }
  window.addEventListener('load', hideOverlay, {once:true});

  // تسلسل تشغيلك الأصلي بدون قفز (نحتفظ به كما هو)
  window.startActivity = function(){
    instr.pause();
    $("#butt2").hide();
    $("#pageHead").show();
    $("#butt2").text("Next");
    document.getElementById('image_holder').style.display = "none";
    counter++; // نعرض السؤال counter-1
    if(counter > promptBank.length){
      $("#promptHolder").text("You have finished.");
      $("#pCount").hide();
      $("#butt2").hide();
      $("#butt3").fadeIn();
      endBlurb.play();
    } else {
      $("#pCount").show();
      $("#promptHolder").text(promptBank[counter-1].text);
      audioElements[counter-1].play();
      $("#pno").text(counter+" / ");
      if(promptBank[counter-1].image && promptBank[counter-1].image.length > 0){
        document.getElementById('image_holder').style.display = "block";
        document.getElementById('promptPic').src = promptBank[counter-1].image;
      }
    }
  };
})();
</script>
</head>

<body>
  <div id="overlay"><img src="loading.gif" alt="Loading" id="loading-image"></div>

  <div id="cont">
    <h1 id="pageHead" style="display:none;">English 3 Speaking Milestone 3</h1>

    <div id="pCount" class="pCount">
      <div style="margin-left:auto;margin-right:0;margin-bottom:5px;width:75px;padding:5px;border-radius:7px;">
        <span id="pno" style="font-size:1.25em"></span><span id="pto"></span>
      </div>
    </div>

    <div class="promptHolder" id="promptHolder">
      <h2 class="iHead" style="font-size:2rem;margin:0 0 1.5rem 0">English 3 Speaking Milestone 3</h2>
      <div class="iText" style="font-size:1.5rem;font-weight:500;margin-top:.5rem">
        <span style="font-weight:bold">This assessment covers these functions:</span>
      </div>
      <div class="iText" style="display:flex;justify-content:center;margin-left:auto;font-size:1.5rem;">
        <ul style="text-align:left;">
          <li>Talking about rules</li>
          <li>Making, accepting, and refusing offers</li>
          <li>Talking about willingness</li>
          <li>Inviting and handling questions</li>
          <li>Asking for, offering, and providing clarification</li>
          <li>Talking about requirements</li>
          <li>Talking about mistakes</li>
          <li>Talking about abbreviations</li>
          <li>Assigning tasks</li>
          <li>Talking about responsibilities</li>
          <li>Talking about purpose and function</li>
          <li>Talking about range and duration</li>
        </ul>
      </div>
    </div>

    <div id="image_holder" style="display:none">
      <span id="closeX" style="text-align:center;position:absolute;right:2%;font-family:arial;font-weight:bold;display:none;background-color:black;border-radius:20px;padding:5px;width:20px;color:white;" onclick="closeImg()">X</span>
      <img id='promptPic' src="" onclick="enlarge()">
      <p id="cap" style="text-align:center;font-family:'Trebuchet MS'">Tap to enlarge</p>
    </div>

    <div style="margin-top: 2em">
      <div class="butt" id="butt"  onclick="introPage()">Continue</div>
      <div class="butt" id="butt1" style="display:none;" onclick="landingPage()">OK</div>
      <div class="butt" id="butt2" style="display:none;" onclick="startActivity()">Start</div>
      <div class="butt" id="butt3" style="display:none" onclick="startOver();">Restart</div>
    </div>
  </div>

  <!-- أصوات الواجهة كما في ملفك -->
  <script>
    window.endBlurb = document.createElement("AUDIO"); endBlurb.src = "E3_E4_End.mp3";
    window.badge    = document.createElement("AUDIO"); badge.src    = "E3_SM3_Intro.mp3";
    window.instr    = document.createElement("AUDIO"); instr.src    = "E3_4_SM3_Inst.mp3";
    window.tgtPhrase= document.createElement("AUDIO");
    tgtPhrase.onended = function(){ $('#butt2').fadeIn(); };
  </script>

  <!-- شغّل المعالجة الآن (بعد ما بدّلناها للأصدار الحتمي) -->
  <script> processArray(targetFunctions); </script>

  <!-- ربط لمس iPad + فتح الصوت بلمسة + تنظيف أي طبقات تغطي -->
  <script>
  (function(){
    function hideOverlay(){ var ov=document.getElementById('overlay'); if(ov){ ov.style.display='none'; ov.style.pointerEvents='none'; ov.style.zIndex='-1'; } }
    hideOverlay(); window.addEventListener('load', hideOverlay, {once:true});

    // اجعل الأزرار تستجيب للّمس والنقر
    function rebind(id, fallback){
      var el = document.getElementById(id); if(!el) return;
      var old = el.onclick;
      el.addEventListener('touchend', function(e){ e.preventDefault(); e.stopPropagation(); (typeof old==='function'?old:fallback)?.call(el,e); }, {passive:false});
      el.addEventListener('click',     function(e){ e.preventDefault(); (typeof old==='function'?old:fallback)?.call(el,e); }, false);
      el.style.pointerEvents='auto'; el.style.cursor='pointer';
    }
    rebind('butt',  function(){ document.getElementById('butt').style.display='none'; document.getElementById('butt1').style.display='inline-block'; });
    rebind('butt1', function(){ document.getElementById('butt1').style.display='none'; var n=document.getElementById('butt2'); n.textContent='Start'; n.style.display='inline-block'; });
    rebind('butt2'); // يعتمد على startActivity المعدّلة
    rebind('butt3', function(){ location.reload(); });

    // iOS: افتح الصوت بلمسة واحدة
    function unlockAudioOnce(){
      try{ var a=new Audio(); a.muted=true; a.src='E3_SM3_Intro.mp3'; a.play().then(()=>{ a.pause(); a.src=''; }).catch(()=>{}); }catch(_){}
      document.removeEventListener('touchend', unlockAudioOnce, true);
    }
    document.addEventListener('touchend', unlockAudioOnce, true);

    // اقتل أي عناصر fixed عالية تغطي الأزرار بالخطأ
    function killCovers(){
      document.querySelectorAll('body *').forEach(el=>{
        var st=getComputedStyle(el);
        if(st.position==='fixed' && +st.zIndex>1000 && !el.closest('.butt')){
          el.style.pointerEvents='none';
        }
      });
    }
    killCovers(); setInterval(killCovers, 800);
  })();
  </script>
</body>
</html>
